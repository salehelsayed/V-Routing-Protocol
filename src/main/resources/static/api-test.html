<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-Routing Protocol API Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .endpoint-card {
            margin-bottom: 20px;
        }
        .response-area {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .status-badge {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>V-Routing Protocol API Test</h1>
        <hr>

        <!-- Start Simulation -->
        <div class="endpoint-card">
            <h3>Start Simulation</h3>
            <div class="card">
                <div class="card-body">
                    <form id="startSimulationForm">
                        <div class="mb-3">
                            <label for="nodeCount" class="form-label">Node Count</label>
                            <input type="number" class="form-control" id="nodeCount" value="5">
                        </div>
                        <div class="mb-3">
                            <label for="duration" class="form-label">Duration</label>
                            <input type="number" class="form-control" id="duration" value="10">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="enableClustering">
                            <label class="form-check-label" for="enableClustering">Enable Clustering</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Start Simulation</button>
                    </form>
                    <div class="response-area" id="startSimulationResponse"></div>
                </div>
            </div>
        </div>

        <!-- Simulation Controls -->
        <div class="endpoint-card">
            <h3>Simulation Controls</h3>
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="simulationId" class="form-label">Simulation ID</label>
                        <input type="text" class="form-control" id="simulationId" readonly>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-info" onclick="checkStatus()">Check Status</button>
                        <button class="btn btn-success" onclick="stepSimulation()">Step Simulation</button>
                        <button class="btn btn-warning" onclick="getMetrics()">Get Metrics</button>
                        <button class="btn btn-danger" onclick="stopSimulation()">Stop Simulation</button>
                    </div>
                    <div class="response-area" id="controlResponse"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let baseUrl = '/api/simulation';
        let currentSimulationId = null;

        // Start Simulation
        document.getElementById('startSimulationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const request = {
                nodeCount: parseInt(document.getElementById('nodeCount').value),
                duration: parseInt(document.getElementById('duration').value),
                enableClustering: document.getElementById('enableClustering').checked
            };

            try {
                const response = await fetch(`${baseUrl}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });

                const data = await response.json();
                displayResponse('startSimulationResponse', data);

                // Update simulation ID if successful
                if (data.success && data.simulationId) {
                    currentSimulationId = data.simulationId;
                    document.getElementById('simulationId').value = currentSimulationId;
                    // Enable control buttons
                    document.querySelectorAll('.btn-group button').forEach(btn => btn.disabled = false);
                } else {
                    currentSimulationId = null;
                    document.getElementById('simulationId').value = '';
                    // Disable control buttons
                    document.querySelectorAll('.btn-group button').forEach(btn => btn.disabled = true);
                }
            } catch (error) {
                displayResponse('startSimulationResponse', { error: error.message });
                currentSimulationId = null;
                document.getElementById('simulationId').value = '';
                // Disable control buttons
                document.querySelectorAll('.btn-group button').forEach(btn => btn.disabled = true);
            }
        });

        // Check Status
        async function checkStatus() {
            if (!currentSimulationId) {
                displayResponse('controlResponse', { error: 'No active simulation' });
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/${currentSimulationId}/status`);
                const data = await response.json();
                displayResponse('controlResponse', data);
            } catch (error) {
                displayResponse('controlResponse', { error: error.message });
            }
        }

        // Step Simulation
        async function stepSimulation() {
            if (!currentSimulationId) {
                displayResponse('controlResponse', { error: 'No active simulation' });
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/${currentSimulationId}/step`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.text();
                displayResponse('controlResponse', { message: data });
                
                // Automatically check status after step
                await checkStatus();
            } catch (error) {
                displayResponse('controlResponse', { error: error.message });
                if (error.message.includes('404')) {
                    // Reset simulation if not found
                    currentSimulationId = null;
                    document.getElementById('simulationId').value = '';
                    document.querySelectorAll('.btn-group button').forEach(btn => btn.disabled = true);
                }
            }
        }

        // Get Metrics
        async function getMetrics() {
            if (!currentSimulationId) {
                displayResponse('controlResponse', { error: 'No active simulation' });
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/${currentSimulationId}/metrics`);
                const data = await response.json();
                displayResponse('controlResponse', data);
            } catch (error) {
                displayResponse('controlResponse', { error: error.message });
            }
        }

        // Stop Simulation
        async function stopSimulation() {
            if (!currentSimulationId) {
                displayResponse('controlResponse', { error: 'No active simulation' });
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/${currentSimulationId}/stop`, {
                    method: 'POST'
                });
                displayResponse('controlResponse', { message: 'Simulation stopped' });
                currentSimulationId = null;
                document.getElementById('simulationId').value = '';
                document.querySelectorAll('.btn-group button').forEach(btn => btn.disabled = true);
            } catch (error) {
                displayResponse('controlResponse', { error: error.message });
            }
        }

        // Helper function to display responses
        function displayResponse(elementId, data) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.style.display = 'block';
        }
    </script>
</body>
</html>
